<link rel="import" href="../vendor/polymer/polymer.html">
<link rel="import" href="../vendor/app-route/app-location.html">
<link rel="import" href="../vendor/iron-pages/iron-pages.html">
<link rel="import" href="../vendor/polymerfire/firebase-app.html">
<link rel="import" href="../vendor/polymerfire/firebase-query.html">
<link rel="import" href="../vendor/polymerfire/firebase-document.html">
<link rel="import" href="pages/landing-page.html">
<link rel="import" href="pages/scoreboard-page.html">
<link rel="import" href="pages/schedule-page.html">
<link rel="import" href="pages/admin-page.html">
<link rel="import" href="widgets/site-header.html">
<link rel="import" href="shared-styles.html">


<dom-module id="upcebu-intrams">
    <template>
        <style include="shared-styles"></style>

        <app-location route="{{route}}"></app-location>

        <firebase-app name="upcebu-intrams"
            auth-domain="upcebu-intrams.firebaseapp.com"
            database-url="https://upcebu-intrams.firebaseio.com/"
            api-key="AIzaSyARO9SFwW_KZ-0GP9qX-SMqy8xyFWK2UeA"></firebase-app>
        <firebase-query app-name="upcebu-intrams" data="{{_standings}}" path="/standings" order-by-value></firebase-query>
        <firebase-document app-name="upcebu-intrams" data="{{_teams}}" path="/teams"></firebase-document>
        <firebase-document app-name="upcebu-intrams" data="{{_schedule}}" path="/schedule"></firebase-document>
        <firebase-query app-name="upcebu-intrams" data="{{_articles}}" path="/articles"></firebase-query>
        <firebase-query app-name="upcebu-intrams" data="{{_events}}" path="/events"></firebase-query>

        <div class="wrap">
            <site-header></site-header>

            <iron-pages selected="{{page}}" attr-for-selected="data-page">
                <landing-page data-page="landing" data="{{data}}"></landing-page>
                <scoreboard-page data-page="scoreboard" data="{{data}}"></scoreboard-page>
                <schedule-page data-page="schedule" data="{{data}}"></schedule-page>
                <admin-page data-page="admin"></admin-page>
            </iron-pages>
        </div>
    </template>
</dom-module>


<script>
    Polymer({
        is: 'upcebu-intrams',

        properties: {
            data: {
                type: Object,
                value: function() {
                    return {
                        teams: {},
                        standings: [],
                        events: [],
                        scores: [],
                        articles: []
                    };
                }
            },

            page: {
                type: String,
                computed: 'computePage(route)'
            }
        },

        observers: [
            // `.splices` observes changes in the data items themselves, not
            // on the array that stores the data items.
            // https://github.com/firebase/polymerfire/issues/67
            'observeStandingsQuery(_standings.splices)',
            'observeTeamsDocument(_teams.*)',
            'observeScheduleDocument(_schedule.*)',
            'observeArticlesQuery(_articles.splices)',
            'observeEventsQuery(_events.splices)'
        ],

        observeStandingsQuery: function() {
            this.debounce('standings', function() {
                if (this.notEmpty(this._teams) && this._standings.length) {
                    this.data.standings = this._standings.map(function(standing) {
                        return { team: standing.$key, score: standing.$val };
                    }).reverse(); // Default is in ascending order
                    this.notifyPath('data.standings');
                }
            }.bind(this));
        },

        observeTeamsDocument: function() {
            this.debounce('teams', function() {
                if (this.notEmpty(this._teams)) {
                    this.data.teams = Object.assign({}, this._teams);
                    this.notifyPath('data.teams');
                }
            }.bind(this));
        },

        observeScheduleDocument: function() {
            this.debounce('schedule', function() {
                if (this.notEmpty(this._teams) && this.notEmpty(this._schedule)) {
                    this.data.events = this.toArray(this._schedule);
                    this.notifyPath('data.events');
                }
            }.bind(this));
        },

        observeArticlesQuery: function() {
            this.debounce('articles', function() {
                if (this._articles.length) {
                    this.data.articles = this._articles.slice();
                    this.notifyPath('data.articles');
                }
            }.bind(this));
        },

        observeEventsQuery: function() {
            this.debounce('events', function() {
                if (this.data.standings.length && this._events.length) {
                    this.data.scores = this._events.map(function(event) {
                        return { event: event.name, teams: event.scores };
                    });
                    this.notifyPath('data.scores');
                }
            }.bind(this));
        },

        computePage: function(route) {
            return route.path.slice(1) || 'landing';
        },

        notEmpty: function(object) {
            return Object.keys(object).length > 0;
        },

        toArray: function(object) {
            return Object.keys(object).map(function(key) {
                return object[key];
            });
        }
    });
</script>
